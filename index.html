<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dreamify - Mystic OS</title>
    <style>
        :root {
            --bg-paper: #f4f4f0;
            --text-ink: #1a1a1a;
            --accent: #ff3b30;
            --font-mono: "SF Mono", "Menlo", "Courier New", monospace;
            --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
            --shadow-float: 0 20px 60px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }

        body {
            background: var(--bg-paper); color: var(--text-ink);
            font-family: var(--font-sans); height: 100vh; width: 100vw;
            overflow: hidden; position: relative;
        }

        /* --- Watermark --- */
        .watermark-floating {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            pointer-events: none; z-index: 0; opacity: 0.03;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            transform: rotate(-20deg); mix-blend-mode: multiply;
        }
        .watermark-text {
            font-family: var(--font-mono); font-weight: 900; font-size: 22px;
            margin: 50px; color: #000; text-transform: uppercase; letter-spacing: 3px;
        }
        .copyright-footer {
            position: absolute; bottom: calc(15px + var(--safe-bottom)); width: 100%;
            text-align: center; font-family: var(--font-mono); font-size: 10px;
            color: #aaa; z-index: 100; pointer-events: none; letter-spacing: 1px;
        }

        /* --- Layout --- */
        .app-wrapper { height: 100%; display: flex; flex-direction: column; padding-bottom: calc(80px + var(--safe-bottom)); z-index: 2; position: relative; }
        .view-container { flex: 1; overflow-y: auto; padding: 24px; scrollbar-width: none; }
        .view-container::-webkit-scrollbar { display: none; }
        
        .view-section { display: none; flex-direction: column; min-height: 100%; }
        .view-section.active { display: flex; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Widgets --- */
        .widget-container { width: 100%; height: 180px; perspective: 1000px; margin-bottom: 24px; }
        .widget-inner { position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-style: preserve-3d; cursor: pointer; }
        .widget-inner.flipped { transform: rotateX(180deg); }
        
        .widget-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            background: #fff; border-radius: 20px; padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.02);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .widget-front { background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 10px 10px; }
        .widget-back { transform: rotateX(180deg); background: #1a1a1a; color: #fff; }

        .w-label { font-family: var(--font-mono); font-size: 10px; opacity: 0.6; letter-spacing: 1px; text-transform: uppercase; }
        .w-val { font-size: 24px; font-weight: 800; margin-top: 4px; letter-spacing: -0.5px; }
        .w-icon { position: absolute; right: 20px; top: 20px; font-size: 32px; }
        
        .tarot-btn {
            margin-top: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 8px 12px; border-radius: 12px; font-size: 12px; font-family: var(--font-mono);
            display: flex; align-items: center; justify-content: space-between; transition: 0.2s;
        }
        .tarot-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }

        /* --- Camera Input --- */
        .camera-frame {
            flex: 1; background: #fff; border-radius: 24px; padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.12); position: relative; display: flex; flex-direction: column;
        }
        .cam-overlay { position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; border: 1px solid rgba(0,0,0,0.1); pointer-events: none; }
        .cam-overlay::before, .cam-overlay::after { content: '+'; position: absolute; font-size: 20px; color: rgba(0,0,0,0.2); }
        .cam-overlay::before { top: -12px; left: -6px; } .cam-overlay::after { bottom: -12px; right: -6px; }
        textarea { width: 100%; flex: 1; border: none; background: transparent; font-size: 18px; line-height: 1.6; resize: none; outline: none; z-index: 2; padding: 10px; }

        /* --- Controls --- */
        .control-bar {
            margin-top: 20px; background: #fff; padding: 10px 20px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .shutter {
            width: 64px; height: 64px; border-radius: 50%; border: 2px solid #e5e5e5;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: transform 0.1s;
        }
        .shutter-in { width: 50px; height: 50px; background: var(--accent); border-radius: 50%; }
        .shutter:active { transform: scale(0.9); }

        /* --- Overlays --- */
        .overlay-base {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; opacity: 0; pointer-events: none;
            transition: 0.5s ease; backdrop-filter: blur(20px);
        }
        .overlay-base.open { opacity: 1; pointer-events: all; }

        /* Tarot */
        .tarot-scene { width: 260px; height: 440px; perspective: 1000px; cursor: pointer; }
        .tarot-card {
            width: 100%; height: 100%; position: relative; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; border-radius: 16px; box-shadow: 0 0 40px rgba(94, 92, 230, 0.3);
        }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .tarot-back {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2e 100%);
            border: 2px solid rgba(255,255,255,0.1);
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 10px);
        }
        .tarot-back::after { content: '‚ú¶'; font-size: 60px; color: rgba(255,255,255,0.2); animation: breathe 3s infinite; }
        .tarot-front {
            transform: rotateY(180deg); background: #fff; color: #000; padding: 20px; text-align: center;
            border: 6px solid #000;
        }
        @keyframes breathe { 0%,100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } }

        /* --- Media Styles --- */
        .media-container { transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(0.9); }
        .overlay-base.open .media-container { transform: scale(1); }
        
        /* Receipt */
        .receipt { background: #fffdf5; width: 300px; padding: 20px; font-family: var(--font-mono); clip-path: inset(0 0 100% 0); }
        .receipt.printing { animation: printScroll 2.5s linear forwards; }
        @keyframes printScroll { to { clip-path: inset(0 0 0 0); } }
        
        /* Polaroid */
        .polaroid { background: #fff; padding: 15px 15px 60px 15px; width: 300px; transform: rotate(-2deg); }
        .polaroid img { width: 100%; aspect-ratio: 1; filter: blur(30px) brightness(0.2) grayscale(1); transition: 3s; }
        .polaroid.developed img { filter: blur(0) brightness(1.1) sepia(0.2); }

        /* Film Negative */
        .film { background: #111; width: 300px; color: #fff; border-radius: 4px; position: relative; cursor: pointer; }
        .film img { width: 100%; filter: invert(1); transition: filter 0.5s ease; border-radius: 2px; }
        .film.developed img { filter: invert(0) !important; } 
        
        .film-strip { height: 24px; background: repeating-linear-gradient(90deg, #000 0, #000 12px, #fff 12px, #fff 20px); opacity: 0.2; }
        .interaction-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 10px; font-family: var(--font-mono); text-align: center;
            pointer-events: none; opacity: 1; transition: opacity 0.3s; mix-blend-mode: difference;
        }
        .film.developed .interaction-hint { opacity: 0; }

        /* Audio Toggle */
        .bgm-toggle { position: fixed; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.05); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .sound-wave { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; opacity: 0.3; }
        .sound-wave.active { animation: pulse 1.5s infinite; opacity: 1; }

    </style>
</head>
<body>

    <!-- BGM -->
    <audio id="bgm-neutral" loop src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3"></audio>
    <audio id="bgm-dark" loop src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_884fe92c21.mp3"></audio>
    <audio id="bgm-bright" loop src="https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3"></audio>

    <div class="watermark-floating">
        <div class="watermark-text">Rabel Mystic</div>
        <div class="watermark-text">Dreamify</div>
        <div class="watermark-text">¬©2025</div>
    </div>
    <div class="copyright-footer">Designed by Rabel ¬∑ Mystic OS v10.2 China</div>

    <div class="bgm-toggle" onclick="toggleAudio()"><div id="audio-dot" class="sound-wave"></div></div>

    <div class="app-wrapper">
        
        <!-- 1. Onboarding -->
        <div id="view-onboarding" class="view-section active">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; padding: 40px;">
                <div style="width:100px; height:100px; border-radius:50%; overflow:hidden; margin:0 auto 20px; border:4px solid #fff;">
                    <img id="avatar-preview" src="https://api.dicebear.com/7.x/notionists/svg?seed=Dreamer" style="width:100%;">
                </div>
                <h1 style="text-align:center; font-family:var(--font-mono); font-size:18px; margin-bottom:20px;">MYSTIC ENTRY</h1>
                <input type="text" id="in-name" placeholder="NAME / ‰ª£Âè∑" oninput="updateAvatar(this.value)" style="padding:15px; border-radius:12px; border:1px solid #ddd; text-align:center; margin-bottom:10px;">
                <input type="text" id="in-city" placeholder="CITY / ÂüéÂ∏Ç (Â¶Ç:Âåó‰∫¨)" style="padding:15px; border-radius:12px; border:1px solid #ddd; text-align:center; margin-bottom:10px;">
                <input type="date" id="in-bday" style="padding:15px; border-radius:12px; border:1px solid #ddd; text-align:center; margin-bottom:20px;">
                <button onclick="initSystem()" style="padding:15px; background:#1a1a1a; color:#fff; border:none; border-radius:12px; font-family:var(--font-mono);">CONNECT</button>
            </div>
        </div>

        <!-- 2. Record / Home -->
        <div id="view-record" class="view-section">
            <div class="view-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h1 style="font-size:28px; font-weight:800;">RECORD.</h1>
                    <div id="date-tag" style="font-family:var(--font-mono); font-size:10px; color:#888; align-self:center;">...</div>
                </div>

                <!-- Widget -->
                <div class="widget-container" onclick="flipWidget(this)">
                    <div class="widget-inner">
                        <!-- Front: Weather -->
                        <div class="widget-face widget-front">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="w-label">LIVE WEATHER</span>
                                <span class="w-label">FLIP ></span>
                            </div>
                            <div>
                                <div class="w-val" id="w-temp">--¬∞C</div>
                                <div class="w-label" id="w-desc" style="margin-top:5px;">CONNECTING...</div>
                                <div class="w-label" id="w-tip" style="margin-top:5px; color:#ff3b30; font-weight:bold;">...</div>
                            </div>
                            <div class="w-icon" id="w-icon">üì°</div>
                        </div>
                        <!-- Back: Zodiac -->
                        <div class="widget-face widget-back">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="w-label">COSMOS LOG</span>
                                <span id="z-loader" style="font-size:10px; opacity:0;">üì∂ UPDATING...</span>
                            </div>
                            <div style="margin-top:10px;">
                                <div class="w-val" id="z-sign" style="font-size:20px;">...</div>
                                <div class="w-label" id="z-detail" style="margin-top:5px; line-height:1.4;">Loading Star Chart...</div>
                            </div>
                            <div class="tarot-btn" onclick="event.stopPropagation(); openTarot();">
                                <span>‚ú® DRAW DAILY TAROT</span>
                                <span>‚Üí</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera Input -->
                <div class="camera-frame">
                    <div class="cam-overlay"></div>
                    <div style="display:flex; justify-content:space-between; font-family:var(--font-mono); font-size:10px; color:var(--accent); margin-bottom:10px;">
                        <span>REC ‚óè</span>
                        <span>ISO 800</span>
                    </div>
                    <textarea id="dream-input" placeholder="Describe your dream...&#10;Âú®Ê≠§Â§ÑÊèèËø∞Ê¢¶Â¢É..."></textarea>
                </div>

                <!-- Control Bar -->
                <div class="control-bar">
                    <div style="display:flex; gap:10px;">
                        <span onclick="setMood('bad', this)" style="font-size:20px; opacity:0.3; transition:0.2s;">üò´</span>
                        <span onclick="setMood('neutral', this)" style="font-size:20px; opacity:1; transition:0.2s;">üòê</span>
                        <span onclick="setMood('good', this)" style="font-size:20px; opacity:0.3; transition:0.2s;">üòå</span>
                    </div>
                    <div class="shutter" onclick="developDream()"><div class="shutter-in"></div></div>
                    <div onclick="switchTab('history')" style="font-size:20px; opacity:0.6;">üìÇ</div>
                </div>
            </div>
        </div>

        <!-- 3. Tarot -->
        <div class="overlay-base" id="tarot-overlay">
            <div class="tarot-scene" onclick="revealTarot(this)">
                <div class="tarot-card">
                    <div class="tarot-face tarot-back"></div>
                    <div class="tarot-face tarot-front">
                        <div style="font-size:80px; margin-bottom:20px;" id="t-icon">üîÆ</div>
                        <div style="font-family:var(--font-mono); font-weight:bold; font-size:18px; margin-bottom:10px;" id="t-name">MYSTERY</div>
                        <div style="font-size:14px; color:#555;" id="t-desc">...</div>
                    </div>
                </div>
            </div>
            <button onclick="closeTarot()" style="position:absolute; bottom:40px; background:none; border:1px solid #fff; color:#fff; padding:8px 20px; border-radius:20px; font-family:var(--font-mono);">EXIT</button>
        </div>

        <!-- 4. Darkroom -->
        <div class="overlay-base" id="darkroom">
            <div class="media-container" id="media-target"></div>
            <div style="margin-top:40px; color:#fff; font-family:var(--font-mono); text-align:center; opacity:0.6;">
                <p style="font-size:10px; margin-bottom:10px;">SCREENSHOT TO SAVE</p>
                <button onclick="closeDarkroom()" style="background:none; border:1px solid #fff; color:#fff; padding:8px 20px; border-radius:20px;">CLOSE</button>
            </div>
        </div>

        <!-- 5. History -->
        <div id="view-history" class="view-section">
            <div class="view-container">
                <h1 style="font-family:var(--font-mono); font-size:18px; margin-bottom:20px;">ARCHIVED ROLLS</h1>
                <div id="history-list"></div>
                <button onclick="switchTab('record')" style="width:100%; padding:15px; border:1px solid #ddd; background:#fff; border-radius:12px; margin-top:20px; font-family:var(--font-mono);">BACK TO CAMERA</button>
            </div>
        </div>

    </div>

    <script>
        /* CONFIG & DB */
        const C={u:'dreamify_v10_u',d:'dreamify_v10_d'}; let S={user:null,mood:'neutral'};
        const audios={n:document.getElementById('bgm-neutral'),d:document.getElementById('bgm-dark'),b:document.getElementById('bgm-bright')};

        /* NLP DB */
        const NLP_DB=[{k:['Ê≠ª','‰∫°','‰∏ß'],m:'d',t:'Ë±°ÂæÅËΩ¨Âåñ‰∏éÈáçÁîü„ÄÇ',s:'ÂëäÂà´ÊòØ‰∏∫‰∫ÜÂºÄÂßã„ÄÇ'},{k:['ËøΩ','Ë∑ë','ÈÄÉ'],m:'d',t:'ËøΩÈÄêËÄÖÊòØ‰Ω†ÂéãÊäëÁöÑÈò¥ÂΩ±„ÄÇ',s:'Èù¢ÂØπÊÅêÊÉßÂç≥Ëá™Áî±„ÄÇ'},{k:['È£û','Áøî'],m:'b',t:'ÂØπËá™Áî±ÁöÑÊ∏¥Êúõ‰∏éË∂ÖË∂ä„ÄÇ',s:'Âú®Âù†ËêΩ‰∏≠Â≠¶‰ºöÈ£ûÁøî„ÄÇ'},{k:['Ê∞¥','Êµ∑','Èõ®'],m:'n',t:'ÊÉÖÊÑü‰∏éÊΩúÊÑèËØÜÁöÑÊµÅÂä®„ÄÇ',s:'‰∏äÂñÑËã•Ê∞¥„ÄÇ'}];
        const GENERIC_DB=[{t:'ÊΩúÊÑèËØÜÂú®Êï¥ÂêàÁêÜÊô∫‰∏éÊÉÖÊÑü„ÄÇ',s:'Êé•Á∫≥ÂÜÖÂøÉÁöÑÊ∑∑Ê≤å„ÄÇ'},{t:'Ê®°Á≥äÊÑèË±°Êò†Â∞ÑÂØπÊú™Êù•ÁöÑ‰∏çÁ°ÆÂÆö„ÄÇ',s:'Ëø∑ÈõæÁªà‰ºöÊï£Âéª„ÄÇ'}];

        /* FALLBACK CHINA CITIES COORDINATES (For reliability) */
        const CN_CITIES = {
            'Âåó‰∫¨':[39.9042,116.4074],'‰∏äÊµ∑':[31.2304,121.4737],'ÂπøÂ∑û':[23.1291,113.2644],'Ê∑±Âú≥':[22.5431,114.0579],'ÊàêÈÉΩ':[30.5728,104.0668],'Êù≠Â∑û':[30.2741,120.1551],'Ê≠¶Ê±â':[30.5928,114.3055],'Ë•øÂÆâ':[34.3416,108.9398],'ÈáçÂ∫Ü':[29.5627,106.5528],'Âçó‰∫¨':[32.0603,118.7969],'Â§©Ê¥•':[39.0842,117.2009],'ËãèÂ∑û':[31.2989,120.5853],'ÈïøÊ≤ô':[28.2282,112.9388],'ÈÉëÂ∑û':[34.7466,113.6253],'Ê≤àÈò≥':[41.8057,123.4315],'ÈùíÂ≤õ':[36.0671,120.3826],'Â§ßËøû':[38.9140,121.6147],'ÂÆÅÊ≥¢':[29.8683,121.5440],'Âé¶Èó®':[24.4798,118.0894],'Á¶èÂ∑û':[26.0745,119.2965],'Êó†Èî°':[31.4912,120.3119],'ÂìàÂ∞îÊª®':[45.8038,126.5349],'ÊµéÂçó':[36.6512,117.1201],'ÈïøÊò•':[43.8171,125.3235],'ÂêàËÇ•':[31.8206,117.2272],'ÊòÜÊòé':[24.8801,102.8329],'ÂçóÊòå':[28.6820,115.8579],'ÂçóÂÆÅ':[22.8170,108.3665],'Ë¥µÈò≥':[26.6470,106.6302],'Â§™Âéü':[37.8706,112.5489],'Áü≥ÂÆ∂Â∫Ñ':[38.0428,114.5149],'Êµ∑Âè£':[20.0174,110.3492]
        };

        window.onload=()=>{ if(localStorage.getItem(C.u)){ S.user=JSON.parse(localStorage.getItem(C.u)); enterApp(); } };
        function updateAvatar(v){ document.getElementById('avatar-preview').src=`https://api.dicebear.com/7.x/notionists/svg?seed=${v}`; }
        function initSystem(){ S.user={name:document.getElementById('in-name').value||'Dreamer',city:document.getElementById('in-city').value||'Âåó‰∫¨',bday:document.getElementById('in-bday').value}; localStorage.setItem(C.u,JSON.stringify(S.user)); enterApp(); playAudio('n'); }
        function enterApp(){ document.getElementById('view-onboarding').classList.remove('active'); document.getElementById('view-record').classList.add('active'); document.getElementById('date-tag').innerText=new Date().toLocaleDateString(); fetchWeather(S.user.city); }

        /* --- MODIFIED WEATHER LOGIC WITH ADVICE --- */
        async function fetchWeather(city) {
            try {
                let lat, lon, name;
                // 1. Try Fallback List first for speed & reliability in China
                for (let k in CN_CITIES) { if(city.includes(k)) { lat=CN_CITIES[k][0]; lon=CN_CITIES[k][1]; name=k; break; } }
                
                // 2. If not in fallback list, use API Geocoding
                if (!lat) {
                    const r1 = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&language=zh&count=1&format=json`);
                    const d1 = await r1.json();
                    if(!d1.results) throw new Error();
                    lat=d1.results[0].latitude; lon=d1.results[0].longitude; name=d1.results[0].name;
                }

                // 3. Fetch Weather
                const r2 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                const d2 = await r2.json();
                const t = d2.current_weather.temperature;
                const c = d2.current_weather.weathercode;
                
                // 4. Determine Icon & Description
                let i="‚òÄÔ∏è", d="Êô¥Êúó";
                if(c>3){i="‚òÅÔ∏è";d="Â§ö‰∫ë";} if(c>45){i="üå´Ô∏è";d="ÊúâÈõæ";} if(c>50){i="üåßÔ∏è";d="ÊúâÈõ®";} if(c>70){i="‚ùÑÔ∏è";d="ÊúâÈõ™";} if(c>95){i="‚ö°";d="Èõ∑Êö¥";}

                // 5. Generate Specific Advice (Umbrella / Clothes)
                let tip = "Â§©Ê∞îËàíÈÄÇÔºåÂøÉÊÉÖ‰∏çÈîô„ÄÇ";
                if (c > 50) tip = "‚òî ËÆ∞ÂæóÂ∏¶‰ºûÔºåË∑ØÈù¢ÊπøÊªë„ÄÇ";
                if (t < 5) tip += " üß£ Á©øÁæΩÁªíÊúç/ÂéöÂ§ñÂ•ó„ÄÇ";
                else if (t < 15) tip += " üß• Âª∫ËÆÆÁ©øÂ§ßË°£ÊàñÊØõË°£„ÄÇ";
                else if (t > 28) tip = "üëï Â§©Ê∞îÁÇéÁÉ≠ÔºåÊ≥®ÊÑèÈò≤Êôí„ÄÇ";
                else if (t > 20) tip = "üëï Á©øTÊÅ§ÊàñËñÑÂ§ñÂ•óÂç≥ÂèØ„ÄÇ";

                // 6. Update UI
                document.getElementById('w-temp').innerText = Math.round(t) + "¬∞C";
                document.getElementById('w-desc').innerText = d + " ¬∑ " + name;
                document.getElementById('w-icon').innerText = i;
                document.getElementById('w-tip').innerText = tip;

            } catch(e) {
                document.getElementById('w-desc').innerText = "Signal Lost ¬∑ Offline";
                document.getElementById('w-tip').innerText = "Êó†Ê≥ïËé∑ÂèñÂÆûÊó∂Âª∫ËÆÆ";
            }
        }

        function getAnalysis(text){
            for(let i of NLP_DB) if(i.k.some(k=>text.includes(k))) return {m:i.m,t:i.t,s:i.s};
            let h=0; for(let i=0;i<text.length;i++) h=text.charCodeAt(i)+((h<<5)-h);
            let g=GENERIC_DB[Math.abs(h)%GENERIC_DB.length]; return {m:'n',t:g.t,s:g.s};
        }
        function developDream(){
            let v=document.getElementById('dream-input').value.trim(); if(!v)return;
            let res=getAnalysis(v); playAudio(res.m);
            let type=Math.floor(Math.random()*3); let img=`https://picsum.photos/seed/${v.length}/600/600`;
            let d={id:Date.now(),text:v,img,type,...res,date:new Date().toLocaleString()};
            saveData(d); openDarkroom(d); document.getElementById('dream-input').value="";
        }
        function openDarkroom(d){
            let t=document.getElementById('media-target'), u=S.user.name.toUpperCase();
            if(d.type===0) t.innerHTML=`<div class="receipt printing"><div style="text-align:center;border-bottom:2px dashed #000;padding-bottom:10px;"><h2>DREAMIFY LOG</h2><div style="font-size:10px;">${d.date}</div></div><div style="font-size:11px;margin-top:10px;">USER: ${u}<br>> ${d.text}<br><br><b>ANALYSIS:</b><br>${d.t}<br><br><i>"${d.s}"</i></div></div>`;
            else if(d.type===1) t.innerHTML=`<div class="polaroid" onclick="this.classList.add('developed')"><div class="polaroid-img"><img src="${d.img}"><div class="interaction-hint">TAP TO DEVELOP</div></div><div style="text-align:center;margin-top:15px;font-family:'Courier New';font-size:12px;">${d.s}</div></div>`;
            else t.innerHTML=`<div class="film" onclick="this.classList.toggle('developed')"><div class="film-strip"></div><div style="padding:20px;position:relative;"><div style="color:#ff3b30;font-size:10px;margin-bottom:5px;">RABEL 800T / NEGATIVE</div><div style="position:relative;border-radius:2px;overflow:hidden;"><img src="${d.img}" style="display:block;"><div class="interaction-hint">TAP TO PROCESS</div></div><div style="font-size:11px;margin-top:15px;font-family:var(--font-mono);line-height:1.4;">> ${d.text}<br><span style="opacity:0.7;">${d.t}</span></div></div><div class="film-strip"></div></div>`;
            document.getElementById('darkroom').classList.add('open');
        }
        function closeDarkroom(){document.getElementById('darkroom').classList.remove('open');playAudio('n');}
        function flipWidget(el){el.querySelector('.widget-inner').classList.toggle('flipped'); if(el.querySelector('.widget-inner').classList.contains('flipped')) loadZodiac();}
        function loadZodiac(){
            document.getElementById('z-loader').style.opacity=1;
            setTimeout(()=>{
                let d=new Date(),b=new Date(S.user.bday), s=d.getDate()+d.getMonth();
                let sg=["Cap","Aqu","Pis","Ari","Tau","Gem","Can","Leo","Vir","Lib","Sco","Sag"];
                let cl=['Ruby','Gold','Azure','Onyx','Pearl'];
                document.getElementById('z-sign').innerText=sg[b.getMonth()].toUpperCase();
                document.getElementById('z-detail').innerHTML=`Luck: ${(s%9)+1}/9<br>Wear: ${cl[s%cl.length]}`;
                document.getElementById('z-loader').style.opacity=0;
            },800);
        }
        const TAROT=[{n:"The Fool",i:"ü§°",d:"New beginnings."},{n:"The Magician",i:"ü™Ñ",d:"Manifestation."},{n:"The Lovers",i:"‚ù§Ô∏è",d:"Harmony."},{n:"Death",i:"üíÄ",d:"Transformation."},{n:"The Sun",i:"‚òÄÔ∏è",d:"Positivity."}];
        let tf=false; function openTarot(){document.getElementById('tarot-overlay').classList.add('open');tf=false;document.querySelector('.tarot-card').classList.remove('flipped');}
        function revealTarot(el){if(tf)return;tf=true;let c=TAROT[Math.floor(Math.random()*TAROT.length)];document.getElementById('t-icon').innerText=c.i;document.getElementById('t-name').innerText=c.n;document.getElementById('t-desc').innerText=c.d;el.querySelector('.tarot-card').classList.add('flipped');}
        function closeTarot(){document.getElementById('tarot-overlay').classList.remove('open');}
        function saveData(d){let l=JSON.parse(localStorage.getItem(C.d)||'[]');l.unshift(d);localStorage.setItem(C.d,JSON.stringify(l));}
        function switchTab(t){
            document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
            if(t==='history'){
                let l=document.getElementById('history-list');l.innerHTML='';
                JSON.parse(localStorage.getItem(C.d)||'[]').forEach(d=>{
                    let e=document.createElement('div');e.style.cssText='background:#fff;padding:15px;border-radius:12px;margin-bottom:10px;border:1px solid #eee;font-family:var(--font-mono);font-size:12px;';e.innerHTML=`<div>${d.date.split(' ')[0]}</div><b>${d.text}</b>`;e.onclick=()=>openDarkroom(d);l.appendChild(e);
                });
            }
            document.getElementById(`view-${t}`).classList.add('active');
        }
        function setMood(m,el){S.mood=m;document.querySelectorAll('.control-bar span').forEach(s=>s.style.opacity=0.3);el.style.opacity=1;}
        function playAudio(k){Object.values(audios).forEach(a=>{a.pause();a.currentTime=0;});if(audios[k]){audios[k].volume=0.4;audios[k].play().catch(()=>{});document.getElementById('audio-dot').classList.add('active');}}
        function toggleAudio(){if(audios.n.paused)playAudio('n');else{Object.values(audios).forEach(a=>a.pause());document.getElementById('audio-dot').classList.remove('active');}}
    </script>
</body>
</html>
